@using TimeCalculator.Base
@using TimeCalculator.Base.Types

<div class="mt-3 mb-3">
    <div class="d-flex align-items-center gap-2">
        <div class="fw-semibold">
            Your daily work: @($"{TimeCalculator.DailyWorkHours} hours")
        </div>

        @if (!_isDailyWorkTimeInputVisible)
        {
            <button class="btn @(TimeCalculator.DailyWorkHours > 0 ? "btn-outline-primary" : "btn-primary")"
                @onclick="@(TimeCalculator.DailyWorkHours > 0 ? EditDailyWorkTime : ShowDailyWorkTimeInput)">
                Edit
            </button>
        }
    </div>

    @if (_isDailyWorkTimeInputVisible)
    {
        <div class="d-flex gap-2 align-items-end mt-2">
            <div class="d-flex flex-column">
                <label class="form-label mb-1">Hours per day</label>
                <input type="number" @bind="_defaultDailyWorkHours" min="1" class="form-control" style="width: 140px;" />
            </div>

            <button class="btn btn-primary" disabled="@(_defaultDailyWorkHours <= 0)"
                @onclick="SetDailyWorkTime">Set</button>
        </div>
    }
</div>

<div class="d-flex gap-2 align-items-end">
    <div class="d-flex flex-column">
        <label class="form-label mb-1">Hours</label>
        <input type="number" @bind="TimeCalculator.CurrentTimeEntry.Hours" min="0" class="form-control"
            style="width: 100px;" />
    </div>

    <div class="d-flex flex-column">
        <label class="form-label mb-1">Minutes</label>
        <input type="number" @bind="TimeCalculator.CurrentTimeEntry.Minutes" min="0" max="59" class="form-control"
            style="width: 100px;" />
    </div>

    <div class="d-flex flex-column">
        <label class="form-label mb-1">Seconds</label>
        <input type="number" @bind="TimeCalculator.CurrentTimeEntry.Seconds" min="0" max="59" class="form-control"
            style="width: 100px;" />
    </div>

    <div class="d-flex flex-column flex-grow-1 align-items-start">
        <label class="form-label mb-1">Type</label>
        <div class="btn-group" role="group" aria-label="Time entry type">
            <button type="button" class="@GetTypeButtonClass(TimeType.Work)"
                aria-pressed="@(IsTypeSelected(TimeType.Work))" @onclick="() => SetType(TimeType.Work)">
                Work
            </button>
            <button type="button" class="@GetTypeButtonClass(TimeType.Break)"
                aria-pressed="@(IsTypeSelected(TimeType.Break))" @onclick="() => SetType(TimeType.Break)">
                Break
            </button>
        </div>
    </div>
</div>

<button class="btn btn-primary mt-3" @onclick="AddTimeEntry">Add Time Entry</button>
<button class="btn btn-outline-primary mt-3" @onclick="SetRemainedTime">Remained Time</button>

@code {
    [Parameter, EditorRequired]
    public TimeCalculatorProgramm TimeCalculator { get; set; } = default!;

    [Parameter]
    public EventCallback OnChanged { get; set; }

    private bool _isDailyWorkTimeInputVisible;
    private int _defaultDailyWorkHours = 8;

    protected override void OnParametersSet()
    {
        if (TimeCalculator.DailyWorkHours <= 0)
        {
            TimeCalculator.DailyWorkHours = _defaultDailyWorkHours;
        }
    }

    private void ShowDailyWorkTimeInput()
    {
        _isDailyWorkTimeInputVisible = true;
    }

    private void EditDailyWorkTime()
    {
        _defaultDailyWorkHours = TimeCalculator.DailyWorkHours > 0 ? TimeCalculator.DailyWorkHours : _defaultDailyWorkHours;
        _isDailyWorkTimeInputVisible = true;
    }

    private void SetDailyWorkTime()
    {
        TimeCalculator.DailyWorkHours = _defaultDailyWorkHours;
        _isDailyWorkTimeInputVisible = false;
        TimeCalculator.CalculateTotalTime();

        _ = NotifyChangedAsync();
    }

    private void AddTimeEntry()
    {
        TimeCalculator.AddTimeEntry();
        _ = NotifyChangedAsync();
    }

    private void SetRemainedTime()
    {
        TimeCalculator.SetRemainedTime();
        _ = NotifyChangedAsync();
    }

    private Task NotifyChangedAsync()
    {
        return OnChanged.HasDelegate ? OnChanged.InvokeAsync() : Task.CompletedTask;
    }

    private void SetType(TimeType type)
    {
        TimeCalculator.SelectedTimeType = type;
    }

    private bool IsTypeSelected(TimeType type)
    {
        return TimeCalculator.SelectedTimeType == type;
    }

    private string GetTypeButtonClass(TimeType type)
    {
        return IsTypeSelected(type) ? "btn btn-primary" : "btn btn-outline-primary";
    }
}